pipeline {
    agent any

    environment {
        GITHUB_USER = credentials('GITHUB_USER')
        GITHUB_TOKEN = credentials('GITHUB_TOKEN')
    }

    stages {
        stage('Install JDK') {
            steps {
                sh '''
                    echo ">>> Downloading JDK 23..."
                    curl -L -o jdk23.tar.gz https://github.com/adoptium/temurin23-binaries/releases/download/jdk-23+37/OpenJDK23U-jdk_x64_linux_hotspot_23_37.tar.gz
                    mkdir -p .jdk
                    tar -xzf jdk23.tar.gz -C .jdk --strip-components=1
                    rm jdk23.tar.gz
                    export JAVA_HOME=$PWD/.jdk
                    export PATH=$JAVA_HOME/bin:$PATH
                    java -version
                '''
            }
        }

        stage('Install Maven') {
            steps {
                sh '''
                    echo ">>> Downloading Maven..."
                    curl -L -o maven.tar.gz https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz
                    mkdir -p .maven
                    tar -xzf maven.tar.gz -C .maven --strip-components=1
                    rm maven.tar.gz
                    export JAVA_HOME=$PWD/.jdk
                    export PATH=$JAVA_HOME/bin:$PWD/.maven/bin:$PATH
                    mvn -v
                '''
            }
        }

        stage('Tests') {
            steps {
                sh '''
                    export JAVA_HOME=$PWD/.jdk
                    export PATH=$JAVA_HOME/bin:$PWD/.maven/bin:$PATH
                    java -version
                    mvn -v
                    mvn clean test --settings src/main/resources/settings.xml
                    mvn verify --settings src/main/resources/settings.xml
                    mvn sonar:sonar --settings src/main/resources/settings.xml \
                      -Dsonar.projectKey=GY-Accounts \
                      -Dsonar.host.url=https://sonar.gycoding.com \
                      -Dsonar.login=sqp_e15c3039759830502652fe564b3cd935ff3d1cf1 \
                      -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                      -Dsonar.coverage.exclusions=**/shared/**,**/model/**,**/config/**,**/dto/**,**/entity/**,**/repository/**,**/exceptions/**,**/AccountsApplication.java
                '''
            }
        }
    }

    post {
        success {
            echo 'Tests passed!'
        }
        failure {
            echo 'Some tests failed.'
        }
    }
}
